<?xml version="1.0" encoding="UTF-8"?>

<project name="Roundcube Installation" default="run">
	<target name="run" depends="prepare,download,install,configure,move,clean" />

	<target name="prepare">
		<mkdir dir=".build" />
		<mkdir dir="htdocs" />
	</target>

	<target name="download" depends="prepare">
		<httpget url="http://sourceforge.net/projects/roundcubemail/files/latest/download" dir=".build" filename="roundcube.tar.gz" followRedirects="true" />
	</target>

	<target name="install" depends="download">
		<untar file=".build/roundcube.tar.gz" todir=".build" forceExtract="true" />

		<exec command="mv .build/roundcubemail*/ .build/roundcube/" />
		<exec command="mv .build/roundcube/config/main.inc.php.dist .build/roundcube/config/main.inc.php" />
		<exec command="mv .build/roundcube/config/db.inc.php.dist .build/roundcube/config/db.inc.php" />

		<exec command="sqlite3 ./.build/roundcube/sqlite.db &lt; ./.build/roundcube/SQL/sqlite.initial.sql" />
	</target>

	<target name="configure" depends="install">
		<reflexive>
			<fileset dir=".build/roundcube/config/" >
				<include name="db.inc.php" />
			</fileset>

			<filterchain>
				<replaceregexp>
					<regexp pattern="mysql://roundcube:pass@localhost/roundcubemail" replace="sqlite://./sqlite.db" ignoreCase="true" />
				</replaceregexp>
			</filterchain>
		</reflexive>

		<reflexive>
			<fileset dir=".build/roundcube/config/" >
				<include name="main.inc.php" />
			</fileset>

			<filterchain>
				<replaceregexp>
					<regexp pattern="\$rcmail_config\['default_host'\] = '';" replace="$rcmail_config['default_host'] = 'localhost';" ignoreCase="true" />
					<regexp pattern="\$rcmail_config\['smtp_server'\] = '';" replace="$rcmail_config['smtp_server'] = 'localhost';" ignoreCase="true" />
					<regexp pattern="\$rcmail_config\['smtp_user'\] = '';" replace="$rcmail_config['smtp_user'] = 'vagrant';" ignoreCase="true" />
					<regexp pattern="\$rcmail_config\['smtp_pass'\] = '';" replace="$rcmail_config['smtp_user'] = 'vagrant';" ignoreCase="true" />
				</replaceregexp>
			</filterchain>
		</reflexive>
	</target>

	<target name="move" depends="configure">
		<exec command="mv .build/roundcube/* htdocs/" />
	</target>

	<target name="clean" depends="move">
		<exec command="rm -rf .build" />
	</target>
</project>
